<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Painita</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="icon" href="data:," />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div id="app"></div>
  <script type="module">
    // Limpia almacenamiento local y de sesi√≥n al iniciar la web
    // EXCEPTO si viene de un login exitoso
    try { 
      const loginSuccess = localStorage.getItem('painita_login_success');
      if (!loginSuccess) {
        localStorage.clear(); 
        sessionStorage.clear(); 
      } else {
        // Remove the flag but keep form data
        localStorage.removeItem('painita_login_success');
      }
    } catch {}    // Fuerza recarga sin cach√© cuando se navega hacia atr√°s o se vuelve a abrir
    window.addEventListener('pageshow', function (event) {
      const perf = performance && performance.getEntriesByType ? performance.getEntriesByType('navigation')[0] : null;
      const persisted = event.persisted || (perf && perf.type === 'back_forward');
      if (persisted) {
        try { window.location.reload(true); } catch { window.location.reload(); }
      }
    });
    import { PageLayout } from './js/components/PageLayout.js';
    import { HeroHeading } from './js/components/HeroHeading.js';
    import { CalculatorPanel } from './js/components/CalculatorPanel.js';
    import { BreakdownPanel } from './js/components/BreakdownPanel.js';
    import { PhoneVerification } from './js/components/PhoneVerification.js';
    import { FinalStep } from './js/components/FinalStep.js';
    import { InstitutionalSection } from './js/components/InstitutionalSection.js';
    import { TestimonialsSection } from './js/components/TestimonialsSection.js';
  import { FooterSection } from './js/components/FooterSection.js';
    import { calcularDesglose } from './js/utils/finanzas.js';
  import { FormStep1 } from './js/components/FormStep1.js';
  import { FormStep2 } from './js/components/FormStep2.js';
  import { FormStep3 } from './js/components/FormStep3.js';
  import { FormStep4 } from './js/components/FormStep4.js';
  import { FormStep5 } from './js/components/FormStep5.js';
  import { FormStep6 } from './js/components/FormStep6.js';
  import { FormStep7 } from './js/components/FormStep7.js';
  import { StatusCard } from './js/components/StatusCard.js';
  import { ensureDataLoaded, getCiudades, isReady as colombiaReady } from './js/utils/colombiaData.js';
  

    const state = {
      monto: 300000,
      plazo: 30,
  fase: 'calculadora', // 'calculadora' | 'celular' | 'password' | 'form' | 'final' | 'aprobado' | 'desembolsado'
      celular: '',
      otp: '',
  password: '',
      solicitudId: null,
  formId: null,
  formStep: 1,
  formData: null,
    };

    const API = location.origin;
    const POLL_MS = 8000; // intervalo de sondeo de estado
    let estadoPoll = null;

    function startEstadoPolling() {
      if (estadoPoll) return;
      estadoPoll = setInterval(async () => {
        if (!state.formId) return;
        try {
          await loadFormulario();
          const est = String(state?.formData?.estado||'').toLowerCase();
          if (est !== 'aprobado') {
            stopEstadoPolling();
            // Cambi√≥ el estado (p.ej., a desembolsado)
            render();
          }
        } catch {}
      }, POLL_MS);
    }

    function stopEstadoPolling() {
      if (estadoPoll) {
        clearInterval(estadoPoll);
        estadoPoll = null;
      }
    }

    // No auto-resume: siempre iniciar en la p√°gina principal/calculadora
    // EXCEPTO si viene de login exitoso
    try {
      const savedFormId = localStorage.getItem('painita_form_id');
      const savedFormStep = localStorage.getItem('painita_form_step');
      if (savedFormId) {
        state.formId = Number(savedFormId);
        state.formStep = Math.min(7, Math.max(1, parseInt(savedFormStep||'1',10) || 1));
        state.fase = 'form';
      }
    } catch {}

    function savePrefs() {
      try { localStorage.setItem('painita_plazo', String(state.plazo)); localStorage.setItem('painita_monto', String(state.monto)); } catch {}
    }

    async function createSolicitud(password) {
      const body = { phone: state.celular, otp: state.otp, password, monto: state.monto, plazo: state.plazo };
      const r = await fetch(API + '/start', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const d = await r.json();
      if (d?.id) state.solicitudId = d.id;
      return d;
    }

    async function startFormulario() {
      const body = { phone: state.celular, monto: state.monto, plazo: state.plazo, password: state.password || undefined };
      const r = await fetch(API + '/form/start', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const d = await r.json();
      if (d?.id) { state.formId = d.id; state.formData = d; }
      return d;
    }

    async function savePaso(step, data) {
      if (!state.formId) throw new Error('No form id');
      const r = await fetch(API + '/form/' + state.formId + '/step', { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ step, data }) });
      const d = await r.json().catch(() => ({}));
      if (!r.ok || (d && d.error)) {
        const msg = d && d.error ? String(d.error) : 'save_failed';
        throw new Error(msg);
      }
      return d;
    }

    async function loadFormulario() {
      if (!state.formId) throw new Error('No form id');
      const r = await fetch(API + '/form/' + state.formId);
      const d = await r.json();
      state.formData = d;
      const est = String(d?.estado||'').toLowerCase();
      if (est === 'aprobado') {
        state.fase = 'aprobado';
        return d;
      } else if (est === 'desembolsado') {
        state.fase = 'desembolsado';
        return d;
      }
      if (typeof d?.paso_actual === 'number') {
        state.formStep = Math.min(7, Math.max(1, Number(d.paso_actual)));
        try {
          localStorage.setItem('painita_form_id', String(state.formId));
          localStorage.setItem('painita_form_step', String(state.formStep));
        } catch {}
      }
      return d;
    }

    function render() {
      const root = document.getElementById('app');
      root.innerHTML = '';

  const sections = [];

      if (state.fase === 'calculadora') {
        sections.push(HeroHeading());
  const row = document.createElement('div'); row.className = 'container-row paired no-gap spaced';
        // Mounts
        const calc = CalculatorPanel({
          monto: state.monto,
          plazo: state.plazo,
          onMonto: (v)=>{ state.monto = v; updateBreakdown(); },
          onPlazo: (v)=>{ state.plazo = v; updateBreakdown(); },
          onSolicitar: ()=>{ savePrefs(); state.fase = 'celular'; render(); },
        });
  const breakdownMount = document.createElement('div');
  breakdownMount.className = 'card breakdown-card';
        row.appendChild(calc);
        row.appendChild(breakdownMount);
        sections.push(row);

        function updateBreakdown() {
          breakdownMount.replaceChildren(BreakdownPanel({ desglose: calcularDesglose(state.monto, state.plazo) }));
        }
        updateBreakdown();
  sections.push(InstitutionalSection());
  sections.push(TestimonialsSection());
  sections.push(FooterSection());
      } else if (state.fase === 'celular') {
        const center = document.createElement('div');
        center.className = 'center-screen';
        center.appendChild(PhoneVerification({
          onVerified: (phone, otp) => { state.celular = phone; state.otp = otp; state.fase = 'password'; render(); },
          onLogin: async (phone, form) => {
            state.celular = phone;
            if (form && form.id) {
              // Resumir formulario existente
              state.formId = form.id;
              state.formData = form;
              const paso = Number(form.paso_actual || 1);
              // Si est√° aprobado, ir a resumen de aprobado
              const est = String(form.estado||'').toLowerCase();
              if (est === 'aprobado') {
                state.fase = 'aprobado';
              } else if (est === 'desembolsado') {
                state.fase = 'desembolsado';
              } else {
                state.formStep = Math.min(7, Math.max(1, paso));
                state.fase = 'form';
              }
              render();
            } else {
              // No hay formulario, continuar con contrase√±a para crear uno
              state.fase = 'password';
              render();
            }
          }
        }));
        sections.push(center);
      } else if (state.fase === 'password') {
        // Minimal password capture inline to avoid a framework
        const card = document.createElement('div'); card.className='card card-center pwd-card';
        card.innerHTML = `
          <div class='pwd-top'>
            <h3 class='card__title'>Crea tu contrase√±a</h3>
            <div class='input-wrap'>
              <input class='input pass' type='password' placeholder='Contrase√±a' autocomplete='new-password' />
              <button type='button' class='toggle-visibility tv1' aria-label='Mostrar u ocultar contrase√±a' title='Mostrar/Ocultar'>
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>
              </button>
            </div>
            <div class='input-wrap'>
              <input class='input pass2' type='password' placeholder='Repite tu contrase√±a' autocomplete='new-password' />
              <button type='button' class='toggle-visibility tv2' aria-label='Mostrar u ocultar contrase√±a' title='Mostrar/Ocultar'>
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>
              </button>
            </div>
            <button class='btn btn-primary next'>Continuar</button>
          </div>
          <div class='error'></div>
        `;
        const err = card.querySelector('.error');
        const pw1 = card.querySelector('.pass');
        const pw2 = card.querySelector('.pass2');
        const t1 = card.querySelector('.tv1');
        const t2 = card.querySelector('.tv2');
        function toggleVisibility(inputEl, btnEl) {
          const show = inputEl.type === 'password';
          inputEl.type = show ? 'text' : 'password';
          btnEl.classList.toggle('on', show);
        }
        t1.addEventListener('click', () => toggleVisibility(pw1, t1));
        t2.addEventListener('click', () => toggleVisibility(pw2, t2));
    card.querySelector('.next').addEventListener('click', async (ev) => {
          const btn = ev.currentTarget;
          const pass = pw1.value || '';
          const pass2v = pw2.value || '';
          if (pass.length < 6) { err.textContent = 'M√≠nimo 6 caracteres'; return; }
          if (pass !== pass2v) { err.textContent = 'Las contrase√±as no coinciden'; return; }
          try {
            state.password = pass;
            btn.disabled = true; const orig = btn.textContent; btn.textContent = 'Creando‚Ä¶'; err.textContent='';
            const s = await createSolicitud(pass);
            if (!s || !s.id) {
              err.textContent = s?.error || 'No se pudo crear la solicitud';
              btn.disabled = false; btn.textContent = orig; return;
            }
            btn.textContent = 'Iniciando formulario‚Ä¶';
            const f = await startFormulario();
            if (!f?.id) { err.textContent = f?.error || 'No se pudo iniciar el formulario'; btn.disabled=false; btn.textContent=orig; return; }
            state.formStep = 1;
            state.fase = 'form';
            render();
          }
          catch (e) {
            err.textContent = 'No se pudo crear la solicitud';
            btn.disabled = false; try { btn.textContent = 'Continuar'; } catch {}
          }
        });
        const center = document.createElement('div');
        center.className = 'center-screen';
        center.appendChild(card);
        sections.push(center);
      } else if (state.fase === 'form') {
        // Si a√∫n no existe formId, in√≠cialo y muestra loader
        if (!state.formId) {
          const loading = document.createElement('div'); loading.className='card card-center';
          loading.innerHTML = `<h3 class='card__title'>Iniciando formulario...</h3><div class='error'></div><button class='btn retry hidden'>Reintentar</button>`;
          const err = loading.querySelector('.error'); const retry = loading.querySelector('.retry');
          const center = document.createElement('div'); center.className='center-screen'; center.appendChild(loading); sections.push(center);
          const doStart = () => {
            err.textContent = ''; retry.classList.add('hidden');
            startFormulario().then(() => render()).catch((e) => { err.textContent = 'No se pudo iniciar el formulario'; retry.classList.remove('hidden'); });
          };
          retry.addEventListener('click', doStart);
          doStart();
          
          // User is logged in at this point
          const isLoggedIn = !!(state.celular || localStorage.getItem('painita_form_id'));
          const userPhone = state.celular || '';
          const page = PageLayout(sections, { userPhone: userPhone, showLogout: isLoggedIn }); 
          document.getElementById('app').appendChild(page); 
          return;
        }
        // Si hay formId pero no hay datos cacheados, c√°rgalos y muestra loader
        if (!state.formData || state.formData.id !== state.formId) {
          const loading = document.createElement('div'); loading.className='card card-center';
          loading.innerHTML = `<h3 class='card__title'>Cargando formulario...</h3><div class='error'></div><button class='btn retry hidden'>Reintentar</button>`;
          const err = loading.querySelector('.error'); const retry = loading.querySelector('.retry');
          const center = document.createElement('div'); center.className='center-screen'; center.appendChild(loading); sections.push(center);
          const doLoad = () => {
            err.textContent = ''; retry.classList.add('hidden');
            loadFormulario().then(() => render()).catch(() => { err.textContent = 'No se pudo cargar el formulario'; retry.classList.remove('hidden'); });
          };
          retry.addEventListener('click', doLoad);
          doLoad();
          
          // User is logged in at this point  
          const isLoggedIn = !!(state.celular || localStorage.getItem('painita_form_id'));
          const userPhone = state.celular || '';
          const page = PageLayout(sections, { userPhone: userPhone, showLogout: isLoggedIn }); 
          document.getElementById('app').appendChild(page); 
          return;
        }
  const card = document.createElement('div'); card.className='card card-center';
  const step = state.formStep;
  const progressWrap = document.createElement('div'); progressWrap.className = 'progress';
  const progressText = document.createElement('div'); progressText.className = 'progress__text'; progressText.textContent = `Paso ${step} de 7`;
  const progressBar = document.createElement('div'); progressBar.className = 'progress__bar'; progressBar.style.width = `${Math.min(100, Math.max(0, (step-1)/6*100))}%`;
  progressWrap.append(progressText, progressBar);
  const title = document.createElement('h3'); title.className='card__title';
        const form = document.createElement('div'); form.className='form-step';
        const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='10px'; btns.style.justifyContent='center';
        const back = document.createElement('button'); back.textContent='Atr√°s'; back.className='btn';
        const next = document.createElement('button'); next.textContent= step>=7 ? 'Finalizar' : 'Continuar'; next.className='btn btn-primary';
        const err = document.createElement('div'); err.className='error';

        function input(placeholder, cls, attrs={}) {
          const el = document.createElement('input'); el.className='input ' + (cls||''); el.placeholder = placeholder; Object.entries(attrs).forEach(([k,v])=> el.setAttribute(k,v)); return el;
        }

        function hydrateFormValues(container, data) {
          if (!data) return;
          container.querySelectorAll('input, select').forEach(el => {
            const key = (el.className || '').split(' ').find(c => c && c !== 'input');
            if (!key) return;
            const val = data[key];
            if (val == null) return;
            el.value = val;
          });
          // Hidrataci√≥n espec√≠fica: email compuesto (usuario + dominio)
          if (data.email) {
            const user = container.querySelector('input.email_local');
            const domainSel = container.querySelector('select.email_domain_select');
            const custom = container.querySelector('input.email_domain_custom');
            const hiddenEmail = container.querySelector('input.email[type="hidden"]');
            if (user && domainSel && custom && hiddenEmail) {
              const parts = String(data.email).split('@');
              if (parts.length >= 2) {
                const local = parts.shift();
                const dom = '@' + parts.join('@');
                user.value = local || '';
                const found = Array.from(domainSel.options).map(o=>o.value).find(d => d.toLowerCase() === dom.toLowerCase());
                if (found) { domainSel.value = found; custom.style.display='none'; custom.value=''; }
                else { domainSel.value = 'otro'; custom.style.display=''; custom.value = dom; }
                hiddenEmail.value = data.email;
              }
            }
          }
          // Hidrataci√≥n espec√≠fica: ciudades dependientes del departamento
          const depSel = container.querySelector('select.department');
          const citySel = container.querySelector('select.city');
          if (depSel && citySel && data.department) {
            const setCities = () => {
              citySel.innerHTML = '';
              const empty = document.createElement('option'); empty.value=''; empty.textContent='Selecciona...'; citySel.appendChild(empty);
              const cities = getCiudades(data.department) || [];
              cities.forEach(c => { const op=document.createElement('option'); op.value=c; op.textContent=c; citySel.appendChild(op); });
              if (data.city) citySel.value = data.city;
            };
            if (!colombiaReady()) { ensureDataLoaded().then(setCities).catch(()=>{}); }
            else setCities();
          }
        }

        if (step === 1) {
          title.textContent = 'Paso 1: Informaci√≥n Personal';
          form.append(FormStep1());
        } else if (step === 2) {
          title.textContent = 'Paso 2: Contacto y residencia';
          form.append(FormStep2());
        } else if (step === 3) {
          title.textContent = 'Paso 3: Actividad econ√≥mica';
          form.append(FormStep3());
        } else if (step === 4) {
          title.textContent = 'Paso 4: Referencias';
          form.append(FormStep4());
        } else if (step === 5) {
          title.textContent = 'Paso 5: Datos bancarios';
          form.append(FormStep5());
        } else if (step === 6) {
          title.textContent = 'Paso 6: Archivos';
          form.append(FormStep6());
        } else if (step === 7) {
          title.textContent = 'Paso 7: Validaci√≥n de identidad';
          form.append(FormStep7());
          // Auto-env√≠o si el control de selfie dispara evento por 3 reintentos
      const onAuto = (e) => {
            const val = e?.detail?.value;
            const data = { selfie: val };
            savePaso(7, data).then(() => {
              try { localStorage.removeItem('painita_selfie_retake_count'); } catch {}
        // Ir a p√°gina de espera
        state.fase = 'espera';
              render();
            }).catch(() => {});
          };
          window.addEventListener('painita:selfie:autoSubmit', onAuto, { once: true });
        }

    // Prefill values from saved data
    hydrateFormValues(form, state.formData);

        back.addEventListener('click', () => { if (state.formStep>1) { state.formStep -= 1; render(); } });

        function validateStep(step) {
          const v = (cls) => (form.querySelector('.'+cls)?.value || '').trim();
          // basic validations for key fields
          if (step === 1) {
            if (!v('first_name') || !v('last_name') || !v('email') || !v('document_number')) return 'Completa los campos obligatorios';
            // Validaci√≥n: expedici√≥n debe ser al menos 18 a√±os despu√©s de nacimiento
            const bdStr = v('birth_date'); const idStr = v('document_issue_date');
            if (bdStr && idStr) {
              const [by,bm,bd] = bdStr.split('-').map(n=>parseInt(n,10));
              const [iy,im,id] = idStr.split('-').map(n=>parseInt(n,10));
              if (by && bm && bd && iy && im && id) {
                const bDate = new Date(by, bm-1, bd);
                const minIssue = new Date(bDate.getTime());
                minIssue.setFullYear(minIssue.getFullYear()+18);
                const issueDate = new Date(iy, im-1, id);
                if (issueDate < minIssue) return 'La fecha de expedici√≥n debe ser al menos 18 a√±os despu√©s de la fecha de nacimiento';
              }
            }
          } else if (step === 2) {
            if (!v('address')) return 'Ingresa tu direcci√≥n';
          } else if (step === 3) {
            if (!v('employment_status')) return 'Selecciona tu situaci√≥n laboral';
          } else if (step === 4) {
            if (!v('reference_one_name') || !v('reference_one_phone')) return 'Ingresa al menos una referencia completa';
          } else if (step === 5) {
            const a = v('account_number'); const b = v('account_number_confirm');
            if (!a || !b) return 'Ingresa y confirma tu cuenta';
            if (a !== b) return 'La confirmaci√≥n de la cuenta no coincide';
          } else if (step === 6) {
            if (!v('id_front') || !v('id_back')) return 'Adjunta las fotos del documento por ambos lados';
          } else if (step === 7) {
            if (!v('selfie')) return 'Toma la foto de validaci√≥n de identidad';
          }
          return null;
        }
        next.addEventListener('click', async () => {
          const data = {};
          // Collect both inputs and selects (previously missed select values)
          form.querySelectorAll('input, select').forEach(el => {
            if (el.dataset && el.dataset.aux) return; // omitir campos auxiliares (email_local, email_domain_custom, etc.)
            const key = (el.className || '').split(' ').find(c=>c && c!=='input');
            if (key) data[key]=el.value;
          });
          const message = validateStep(step);
          if (message) { err.textContent = message; return; }
          try {
            const saved = await savePaso(step, data);
            // cache latest saved values only if valid
            if (saved && saved.id) state.formData = saved;
            if (step >= 7) {
              try {
                localStorage.setItem('painita_form_id', String(state.formId));
                localStorage.setItem('painita_form_step', String(step));
              } catch {}
              state.fase = 'espera'; render(); return;
            }
            state.formStep += 1;
            try {
              localStorage.setItem('painita_form_id', String(state.formId));
              localStorage.setItem('painita_form_step', String(state.formStep));
            } catch {}
            // If we just saved step 6, notify to reset retake counters
            if (step === 6) {
              try { window.dispatchEvent(new CustomEvent('painita:step6:saved')); } catch {}
            }
            render();
          } catch (e) {
            err.textContent = 'No se pudo guardar el paso';
          }
        });

        if (step === 1) back.disabled = true;

        btns.append(back, next);
        card.append(progressWrap, title, form, btns, err);
        const center = document.createElement('div'); center.className='center-screen'; center.appendChild(card); sections.push(center);
      } else if (state.fase === 'final') {
        const desg = calcularDesglose(state.monto, state.plazo);
  sections.push(FinalStep({ totalPagar: desg.totalPagar, celular: state.celular, solicitudId: state.solicitudId }));
  sections.push(FooterSection());
      } else if (state.fase === 'espera') {
        const statusCard = StatusCard({
          title: '¬°Bienvenido Panita!',
          subtitle: 'Tu solicitud est√° siendo procesada',
          status: {
            type: 'info',
            text: 'En revisi√≥n'
          },
          icon: '‚è≥',
          details: [
            {
              type: 'info',
              text: 'Tu pr√©stamo est√° en estado de espera. En un lapso de 10 a 30 minutos puedes volver y conocer tu preaprobado.'
            },
            {
              type: 'info', 
              text: 'Puedes cerrar esta ventana y regresar m√°s tarde. Te notificaremos cuando tengamos una respuesta.'
            }
          ]
        });
        const center = document.createElement('div'); 
        center.className='center-screen'; 
        center.appendChild(statusCard); 
        sections.push(center);
      } else if (state.fase === 'aprobado') {
        const f = state.formData || {};
        const monto = Number(f.monto||0);
        const plazo = Number(f.plazo||0);
        const desg = calcularDesglose(monto, plazo);
        const due = new Date(); 
        due.setDate(due.getDate() + (plazo||0));
        const dueStr = due.toLocaleDateString('es-CO', { year:'numeric', month:'long', day:'numeric' });
        const accepted = String(f?.cliente_acepto||'').toLowerCase() === 'si';
        
        const details = [
          {
            type: 'summary',
            title: 'Resumen de tu pr√©stamo',
            items: [
              {
                label: 'Monto aprobado',
                value: desg.monto.toLocaleString('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 })
              },
              {
                label: 'Plazo',
                value: `${plazo} d√≠as`
              },
              {
                label: 'Fecha de pago',
                value: dueStr
              }
            ]
          }
        ];
        
        if (!accepted) {
          details.push({
            type: 'info',
            text: 'Para continuar con el proceso de desembolso, necesitas aceptar formalmente el pr√©stamo con las condiciones mostradas.'
          });
        } else {
          details.push({
            type: 'info', 
            text: 'Estamos preparando tu desembolso. En 5 a 10 minutos tendr√°s el dinero en tu cuenta. Gracias por elegir Painita.'
          });
          details.push({
            type: 'info',
            text: 'Puedes permanecer en esta p√°gina. Actualizaremos autom√°ticamente cuando el estado cambie.'
          });
        }
        
        const actions = [];
        const errEl = document.createElement('div'); 
        errEl.className='error'; 
        errEl.style.marginTop='8px';
        
        if (!accepted) {
          actions.push({
            type: 'primary',
            text: 'Aceptar pr√©stamo',
            onClick: async (e) => {
              e.target.disabled = true; 
              errEl.textContent='';
              try {
                await fetch(`${API}/form/${state.formId}/accept`, { method: 'PATCH' });
                try { await loadFormulario(); } catch {}
                state.formData = Object.assign({}, state.formData, { cliente_acepto: 'si' });
                render();
              } catch (error) {
                e.target.disabled = false;
                errEl.textContent = 'No se pudo registrar tu aceptaci√≥n. Intenta de nuevo.';
              }
            }
          });
        } else {
          startEstadoPolling();
        }
        
        const statusCard = StatusCard({
          title: 'Tu pr√©stamo ha sido aprobado',
          subtitle: accepted ? 'Preparando desembolso...' : 'Esperando tu aceptaci√≥n',
          status: {
            type: accepted ? 'success' : 'warning',
            text: accepted ? 'Procesando' : 'Pendiente aceptaci√≥n'
          },
          icon: '‚úÖ',
          details: details,
          breakdown: BreakdownPanel({ desglose: desg }),
          actions: actions
        });
        
        if (!accepted) {
          statusCard.appendChild(errEl);
        }
        
        const center = document.createElement('div'); 
        center.className='center-screen'; 
        center.appendChild(statusCard); 
        sections.push(center);
        setTimeout(() => { if (state.fase !== 'aprobado') stopEstadoPolling(); }, 0);
      } else if (state.fase === 'desembolsado') {
        const f = state.formData || {};
        const monto = Number(f.monto || 0);
        const plazo = Number(f.plazo || 0);
        const desg = calcularDesglose(monto, plazo);
        const due = new Date();
        due.setDate(due.getDate() + (plazo || 0));
        const dueStr = due.toLocaleDateString('es-CO', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        const details = [
          {
            type: 'summary',
            title: 'Detalles del cr√©dito',
            items: [
              {
                label: 'Monto desembolsado',
                value: monto.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })
              },
              {
                label: 'Plazo',
                value: `${plazo} d√≠as`
              },
              {
                label: 'Fecha de pago',
                value: dueStr
              },
              {
                label: 'Total a pagar',
                value: desg.totalPagar.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 })
              }
            ]
          },
          {
            type: 'info',
            text: 'El dinero ya est√° disponible en tu cuenta bancaria. Puedes realizar el pago de tu cr√©dito usando el bot√≥n de abajo.'
          }
        ];
        
        const linkWrap = document.createElement('div');
        linkWrap.style.marginTop = '8px';
        const linkA = document.createElement('a');
        linkA.target = '_blank';
        linkA.rel = 'noopener';
        linkWrap.append('Link de pago: ', linkA);
        
        const errEl = document.createElement('div');
        errEl.className = 'error';
        errEl.style.marginTop = '8px';
        
        const actions = [
          {
            type: 'primary',
            text: 'Generar link de pago',
            onClick: async (e) => {
              const refId = state.solicitudId || state.formId;
              if (!refId) {
                alert('No hay solicitud');
                return;
              }
              try {
                const body = { monto: Math.round(desg.totalPagar), plazoDias: plazo };
                const r = await fetch(`${API}/payment-link/${refId}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(body)
                });
                const d = await r.json();
                if (d && d.link) {
                  linkA.href = d.link;
                  linkA.textContent = d.link;
                  errEl.textContent = '';
                } else {
                  errEl.textContent = 'No se pudo generar el link de pago.';
                }
              } catch (e) {
                errEl.textContent = 'No se pudo generar el link de pago.';
              }
            }
          }
        ];
        
        const statusCard = StatusCard({
          title: 'Tu cr√©dito ha sido desembolsado',
          subtitle: 'El dinero est√° disponible en tu cuenta',
          status: {
            type: 'success',
            text: 'Desembolsado'
          },
          icon: 'üí∞',
          details: details,
          breakdown: BreakdownPanel({ desglose: desg }),
          actions: actions
        });
        
        statusCard.appendChild(linkWrap);
        statusCard.appendChild(errEl);
        
        const center = document.createElement('div');
        center.className = 'center-screen';
        center.appendChild(statusCard);
        sections.push(center);
      }

      // Determine if user is logged in for header
      const isLoggedIn = !!(state.celular || localStorage.getItem('painita_form_id'));
      const userPhone = state.celular || '';
      
      const page = PageLayout(sections, { 
        userPhone: userPhone, 
        showLogout: isLoggedIn 
      });
      root.appendChild(page);
    }

    render();
  </script>
</body>
</html>
