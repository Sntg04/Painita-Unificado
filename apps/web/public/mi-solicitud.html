<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mi Solicitud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:," />
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    .kv { display: grid; grid-template-columns: 140px 1fr; gap: 8px; }
    pre { background: #f7f7f7; padding: 12px; border-radius: 8px; }
  </style>
</head>
<body>
  <a href="index.html">← Volver</a>
  <h1>Estado de mi solicitud</h1>
  <div class="kv">
    <div><b>ID</b></div><div id="id">-</div>
    <div><b>Status</b></div><div id="status">-</div>
    <div><b>Monto</b></div><div id="amount">-</div>
  </div>
  <div style="margin:12px 0;">
    <button id="createDemo">Crear solicitud demo</button>
    <label style="margin-left:10px;">Set ID manual: <input id="setId" placeholder="e.g. 1" style="width:80px" /> <button id="saveId">Guardar</button></label>
  <!doctype html>
  <html>
  <head>
    <meta charset="utf-8" />
    <title>Iniciar sesión</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" href="data:," />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
      :root { --primary:#B00020; }
      body { font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; margin:0; background:#fff; color:#111; }
      .center { min-height:100dvh; display:grid; place-items:center; padding:20px; }
      .card { width:min(460px, 96vw); border:1px solid rgba(0,0,0,0.08); border-radius:14px; padding:20px; box-shadow: 0 6px 30px rgba(0,0,0,0.06); }
      h1 { margin:0 0 6px 0; font-size:1.6rem; color:#111; }
      p  { margin:0 0 14px 0; color:#444; }
      .input { width:100%; padding:10px 12px; border:1px solid #d5d5d5; border-radius:10px; font-size:1rem; }
      .btn { width:100%; padding:10px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:800; background:var(--primary); color:#fff; }
      .error { color:#b00020; margin-top:10px; }
      a { color: var(--primary); text-decoration: none; }
    </style>
    <script>
      async function doLogin(){
        const phone = (document.getElementById('phone').value||'').replace(/\D/g,'').slice(0,10);
        const password = document.getElementById('pass').value;
        const err = document.getElementById('err'); err.textContent='';
        if (phone.length !== 10) { err.textContent='Ingresa un número válido'; return; }
        if (!password) { err.textContent='Ingresa tu contraseña'; return; }
        try {
          const r = await fetch('/clientes/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, password }) });
          const d = await r.json().catch(()=>({}));
          if (!r.ok) {
            if (r.status===404) err.textContent='Usuario no encontrado';
            else if (r.status===401) err.textContent='Contraseña incorrecta';
            else err.textContent = d?.error || 'No se pudo iniciar sesión';
            return;
          }
          const form = d?.formulario || null;
          if (form && form.id) {
            try {
              localStorage.setItem('painita_form_id', String(form.id));
              localStorage.setItem('painita_form_step', String(form.paso_actual || 1));
            } catch {}
          }
          location.href = '/';
        } catch(e) {
          err.textContent = 'Error de red';
        }
      }
      document.addEventListener('DOMContentLoaded', () => {
        // Eliminar cualquier contenido ajeno al login (por historial/bfcache)
        try {
          const root = document.getElementById('root');
          if (root) {
            Array.from(document.body.children).forEach(n => { if (n !== root) n.remove(); });
          }
        } catch {}
        document.getElementById('doLogin').addEventListener('click', doLogin);
        document.getElementById('pass').addEventListener('keydown', (e)=>{ if (e.key==='Enter') doLogin(); });
      });
    </script>
  </head>
  <body>
    <div class="center" id="root">
      <div class="card">
        <h1>Inicia sesión</h1>
        <p>Continúa tu solicitud en el paso donde ibas.</p>
        <div style="display:grid; gap:10px;">
          <input id="phone" class="input" placeholder="Celular" maxlength="10" />
          <input id="pass" class="input" type="password" placeholder="Contraseña" />
          <button id="doLogin" class="btn">Entrar</button>
          <div id="err" class="error"></div>
        </div>
        <p style="margin-top:12px;">¿No tienes cuenta? <a href="/">Solicita tu crédito</a></p>
      </div>
    </div>
    <script>
      // Limpieza defensiva en navegadores con historial/previa cache
      try { document.body.scrollTop = 0; document.documentElement.scrollTop = 0; } catch {}
      try { document.body.innerHTML = document.body.innerHTML; } catch {}
    </script>
  </body>
  </html>
