<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Painita</title>
  <style>
    :root { --primary:#B00020; --white:#fff; --black:#000; --sidebar-w: 240px; }
    * { box-sizing: border-box; }
    body { font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans"; margin:0; color: var(--black); background: var(--white); }
    .layout { display:flex; min-height:100dvh; }
    .sidebar { width: var(--sidebar-w); background: #faf6f7; border-right:1px solid rgba(0,0,0,0.06); padding:16px; position:sticky; top:0; align-self:flex-start; height:100dvh; }
    .brand { margin:0 0 12px 0; font-family:'Playfair Display', serif; color: var(--primary); font-size: 1.5rem; }
    .nav { display:flex; flex-direction:column; gap:6px; }
    .nav a { display:block; color:#333; text-decoration:none; padding:8px 10px; border-radius:8px; font-weight:700; }
    .nav a:hover, .nav a.active { background:#f2e5e8; color:#b00020; }
    .content { flex:1; padding:20px; }
  h2 { margin:0 0 8px 0; font-size:1.125rem; color:#333; }
    section { margin:0 0 24px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: .95rem; }
    th { background: #f7f7f7; text-align: left; }
  .form-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .input { padding:8px 10px; border:1px solid #ccc; border-radius:8px; }
  .btn { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-family:'Nunito', sans-serif; font-weight:700; }
  .btn.primary { background: var(--primary); color:#fff; }
  .btn.danger { background: #b00020; color:#fff; opacity:0.9; }
  .btn.link { background:transparent; color: var(--primary); text-decoration:underline; padding:0; }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
  <script>
    function setActive(id) {
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      const el = document.querySelector(`.nav a[href="#${id}"]`);
      if (el) el.classList.add('active');
    }
    function showSection(id) {
      document.querySelectorAll('main.content section').forEach(s => { s.style.display = (s.id === id) ? 'block' : 'none'; });
      setActive(id);
    }
    async function loadData() {
      try {
        const r = await fetch('/admin/data', { credentials:'include' });
        if (!r.ok) return;
        const d = await r.json(); if (!d.ok) return;
        const bc = document.querySelector('#tClientes tbody');
        bc.innerHTML = '';
        (d.clientes||[]).forEach(x => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${x.id}</td><td>${x.phone||x.celular||''}</td><td>${x.created_at||''}</td>`;
          bc.appendChild(tr);
        });
        const bs = document.querySelector('#tStaff tbody');
        bs.innerHTML = '';
        (d.usuarios||[]).forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.id}</td><td>${u.email||''}</td><td>${u.role||'agent'}</td><td>${u.created_at||''}</td>`;
          bs.appendChild(tr);
        });
      } catch {}
    }
    window.addEventListener('DOMContentLoaded', () => {
      loadData();
      // Navigation: show only selected section
      document.querySelectorAll('.nav a').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const id = a.getAttribute('href').slice(1);
          history.replaceState(null, '', `#${id}`);
          showSection(id);
        });
      });
      const initial = (location.hash||'').slice(1) || 'usuarios-web';
      showSection(initial);
      window.addEventListener('hashchange', () => {
        const id = (location.hash||'').slice(1) || 'usuarios-web';
        showSection(id);
      });
    });
  </script>
  </head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h1 class="brand">Painita</h1>
      <nav class="nav">
        <a href="#usuarios-web" class="active">Usuarios Web</a>
        <a href="#usuarios-crm">Usuarios CRM</a>
        <a href="#formularios">Formularios</a>
      </nav>
    </aside>
    <main class="content">
      <section id="usuarios-web">
        <h2>Usuarios Web (Clientes)</h2>
        <div class="form-row">
          <input class="input" id="c_phone" placeholder="Teléfono (10 dígitos)" />
          <input class="input" id="c_pass" placeholder="Contraseña" type="password" />
          <button class="btn primary" id="c_create">Crear</button>
        </div>
        <table id="tClientes"><thead><tr><th>ID</th><th>Teléfono</th><th>Creado</th><th>Acciones</th></tr></thead><tbody></tbody></table>
      </section>
  <section id="usuarios-crm">
        <h2>Usuarios CRM (Staff)</h2>
        <div class="form-row">
          <input class="input" id="u_email" placeholder="Email" />
          <input class="input" id="u_pass" placeholder="Contraseña" type="password" />
          <select class="input" id="u_role">
            <option value="agent">agent</option>
            <option value="admin">admin</option>
          </select>
          <button class="btn primary" id="u_create">Crear</button>
        </div>
        <table id="tStaff"><thead><tr><th>ID</th><th>Email</th><th>Rol</th><th>Creado</th><th>Acciones</th></tr></thead><tbody></tbody></table>
      </section>
      <section id="formularios">
        <h2>Formularios</h2>
        <div class="form-row">
          <input class="input" id="f_phone" placeholder="Teléfono (10 dígitos)" />
          <input class="input" id="f_monto" placeholder="Monto" type="number" />
          <input class="input" id="f_plazo" placeholder="Plazo (meses)" type="number" />
          <input class="input" id="f_pass" placeholder="Contraseña (si crea cliente)" type="password" />
          <button class="btn primary" id="f_create">Crear</button>
        </div>
        <table id="tForms"><thead><tr><th>ID</th><th>Celular</th><th>Monto</th><th>Plazo</th><th>Paso</th><th>Estado</th><th>Creado</th><th>Acciones</th></tr></thead><tbody></tbody></table>
      </section>
    </main>
  </div>
  <script>
    async function api(method, url, body) {
      const r = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, credentials:'include', body: body ? JSON.stringify(body) : undefined });
      const d = await r.json().catch(() => ({}));
      if (!r.ok || d.ok === false) throw new Error(d.error || 'request_failed');
      return d;
    }
    function phoneValid(p) { return /^\d{10}$/.test(String(p||'')); }
    function renderClientes(list) {
      const tb = document.querySelector('#tClientes tbody'); tb.innerHTML='';
      list.forEach(x => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.id}</td><td><input class="input c_edit_phone" data-id="${x.id}" value="${x.phone||''}" /></td><td>${x.created_at||''}</td><td><button class="btn" data-action="save" data-id="${x.id}">Guardar</button> <button class="btn danger" data-action="del" data-id="${x.id}">Eliminar</button></td>`;
        tb.appendChild(tr);
      });
    }
    function renderUsuarios(list) {
      const tb = document.querySelector('#tStaff tbody'); tb.innerHTML='';
      list.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.id}</td><td><input class="input u_edit_email" data-id="${u.id}" value="${u.email||''}" /></td><td><select class="input u_edit_role" data-id="${u.id}"><option ${u.role==='agent'?'selected':''} value="agent">agent</option><option ${u.role==='admin'?'selected':''} value="admin">admin</option></select></td><td>${u.created_at||''}</td><td><button class="btn" data-action="saveu" data-id="${u.id}">Guardar</button> <button class="btn danger" data-action="delu" data-id="${u.id}">Eliminar</button></td>`;
        tb.appendChild(tr);
      });
    }
    function renderFormularios(list) {
      const tb = document.querySelector('#tForms tbody'); tb.innerHTML='';
      list.forEach(x => {
        const tr = document.createElement('tr');
        const estado = x.estado || 'pendiente';
        const paso = Number(x.paso_actual||0);
        tr.innerHTML = `<td>${x.id}</td>
          <td><input class="input f_edit_phone" data-id="${x.id}" value="${x.celular||''}" /></td>
          <td><input class="input f_edit_monto" type="number" data-id="${x.id}" value="${x.monto ?? ''}" /></td>
          <td><input class="input f_edit_plazo" type="number" data-id="${x.id}" value="${x.plazo ?? ''}" /></td>
          <td><input class="input f_edit_paso" type="number" min="0" max="7" data-id="${x.id}" value="${paso}" /></td>
          <td><select class="input f_edit_estado" data-id="${x.id}"><option ${estado==='pendiente'?'selected':''} value="pendiente">pendiente</option><option ${estado==='en_espera'?'selected':''} value="en_espera">en_espera</option><option ${estado==='aprobado'?'selected':''} value="aprobado">aprobado</option><option ${estado==='rechazado'?'selected':''} value="rechazado">rechazado</option></select></td>
          <td>${x.created_at||''}</td>
          <td><button class="btn" data-action="savef" data-id="${x.id}">Guardar</button> <button class="btn danger" data-action="delf" data-id="${x.id}">Eliminar</button></td>`;
        tb.appendChild(tr);
      });
    }
    async function loadData() {
      try {
        const r = await fetch('/admin/data', { credentials:'include' });
        if (!r.ok) return; const d = await r.json(); if (!d.ok) return;
  renderClientes(d.clientes||[]);
  renderUsuarios(d.usuarios||[]);
  renderFormularios(d.formularios||[]);
      } catch {}
    }
    window.addEventListener('DOMContentLoaded', () => {
      // Create client
      document.getElementById('c_create').addEventListener('click', async () => {
        const phone = document.getElementById('c_phone').value.trim();
        const pass = document.getElementById('c_pass').value;
        if (!phoneValid(phone)) { alert('Teléfono inválido (10 dígitos)'); return; }
        if (!pass) { alert('Contraseña requerida'); return; }
        try { await api('POST','/admin/clients',{ phone, password: pass }); document.getElementById('c_phone').value=''; document.getElementById('c_pass').value=''; await loadData(); } catch(e){ alert('No se pudo crear: '+e.message); }
      });
      // Save/delete client (event delegation)
      document.querySelector('#tClientes').addEventListener('click', async (ev) => {
        const btn = ev.target.closest('button'); if (!btn) return; const id = btn.dataset.id; const action = btn.dataset.action;
        if (action === 'save') {
          const phone = document.querySelector(`.c_edit_phone[data-id="${id}"]`).value.trim(); if (!phoneValid(phone)) { alert('Teléfono inválido'); return; }
          try { await api('PATCH', `/admin/clients/${id}`, { phone }); await loadData(); } catch(e){ alert('No se pudo guardar: '+e.message); }
        } else if (action === 'del') {
          if (!confirm('¿Eliminar cliente?')) return; try { await api('DELETE', `/admin/clients/${id}`); await loadData(); } catch(e){ alert('No se pudo eliminar: '+e.message); }
        }
      });
      // Create user
      document.getElementById('u_create').addEventListener('click', async () => {
        const email = document.getElementById('u_email').value.trim();
        const pass = document.getElementById('u_pass').value;
        const role = document.getElementById('u_role').value;
        if (!email) { alert('Email requerido'); return; }
        if (!pass) { alert('Contraseña requerida'); return; }
        try { await api('POST','/admin/users',{ email, password: pass, role }); document.getElementById('u_email').value=''; document.getElementById('u_pass').value=''; await loadData(); } catch(e){ alert('No se pudo crear: '+e.message); }
      });
      // Save/delete user
      document.querySelector('#tStaff').addEventListener('click', async (ev) => {
        const btn = ev.target.closest('button'); if (!btn) return; const id = btn.dataset.id; const action = btn.dataset.action;
        if (action === 'saveu') {
          const email = document.querySelector(`.u_edit_email[data-id="${id}"]`).value.trim();
          const role = document.querySelector(`.u_edit_role[data-id="${id}"]`).value;
          try { await api('PATCH', `/admin/users/${id}`, { email, role }); await loadData(); } catch(e){ alert('No se pudo guardar: '+e.message); }
        } else if (action === 'delu') {
          if (!confirm('¿Eliminar usuario?')) return; try { await api('DELETE', `/admin/users/${id}`); await loadData(); } catch(e){ alert('No se pudo eliminar: '+e.message); }
        }
      });
      // Create formulario
      document.getElementById('f_create').addEventListener('click', async () => {
        const phone = document.getElementById('f_phone').value.trim();
        const monto = Number(document.getElementById('f_monto').value || 0) || undefined;
        const plazo = Number(document.getElementById('f_plazo').value || 0) || undefined;
        const pass = document.getElementById('f_pass').value;
        if (!phoneValid(phone)) { alert('Teléfono inválido'); return; }
        try { await api('POST','/admin/forms',{ phone, monto, plazo, password: pass }); document.getElementById('f_phone').value=''; document.getElementById('f_monto').value=''; document.getElementById('f_plazo').value=''; document.getElementById('f_pass').value=''; await loadData(); }
        catch(e){ alert('No se pudo crear: '+e.message); }
      });
      // Save/delete formulario (delegation)
      document.querySelector('#tForms').addEventListener('click', async (ev) => {
        const btn = ev.target.closest('button'); if (!btn) return; const id = btn.dataset.id; const action = btn.dataset.action;
        if (action === 'savef') {
          const celular = document.querySelector(`.f_edit_phone[data-id="${id}"]`).value.trim();
          const monto = Number(document.querySelector(`.f_edit_monto[data-id="${id}"]`).value || 0) || undefined;
          const plazo = Number(document.querySelector(`.f_edit_plazo[data-id="${id}"]`).value || 0) || undefined;
          const paso_actual = Number(document.querySelector(`.f_edit_paso[data-id="${id}"]`).value || 0) || 0;
          const estado = document.querySelector(`.f_edit_estado[data-id="${id}"]`).value;
          if (!phoneValid(celular)) { alert('Teléfono inválido'); return; }
          try { await api('PATCH', `/admin/forms/${id}`, { celular, monto, plazo, paso_actual, estado }); await loadData(); } catch(e){ alert('No se pudo guardar: '+e.message); }
        } else if (action === 'delf') {
          if (!confirm('¿Eliminar formulario?')) return; try { await api('DELETE', `/admin/forms/${id}`); await loadData(); } catch(e){ alert('No se pudo eliminar: '+e.message); }
        }
      });
      loadData();
    });
  </script>
</body>
</html>
